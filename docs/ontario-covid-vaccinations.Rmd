---
title: Progress
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include = FALSE}
# install.packages(c("rjson", "tidyverse", "lubridate", "knitr", "readxl"))
library(knitr) # formatting tables in markdown
library(rjson) # for reading api
library(tidyverse) # for visualisations
library(lubridate) # for converting character strings to dates
library(readxl) # for reading Excel spreadsheets into R
library(stringr) # For converting text to title case
```

```{r data sources, include = FALSE}
vaxxdata <-
  (
    "https://data.ontario.ca/api/3/action/datastore_search?resource_id=8a89caa9-511c-4568-af89-7f2174b4378c&limit=1000"
  ) #API set to capture first 1000 records.

# Get population data.
ONpop <-
  (
    "https://data.ontario.ca/datastore/dump/775ca815-5028-4e9b-9dd4-6975ff1be021?bom=True"
  )
age <- read.csv(ONpop)
latestage <- tail(age, n = 11)
ONpop12plus <-
  latestage[10, 6]  # Capture total  12+ population total from the Ontario COVID-19 by age dataset.
PHU <-
  read.csv(
    "https://data.ontario.ca/dataset/752ce2b7-c15a-4965-a3dc-397bf405e7cc/resource/2a362139-b782-43b1-b3cb-078a2ef19524/download/vaccines_by_age_phu.csv"
  )
```

```{r vaccination data, include = FALSE}
# Transform vaccination data into a data frame.
vaxx <- fromJSON(file = vaxxdata) # Read in API JSON data
vaxx <- (vaxx$result$records) # Isolate vaccination data fields
vaxx <-
  as.data.frame(do.call(cbind, vaxx)) # Bind days into a data frame.
vaxx <- t(vaxx) # transpose dataframe
vaxx <-
  apply(vaxx, 2, function(y)
    sapply(y, function(x)
      ifelse(is.null(x), 0, x))) # Replace null values with zeros.
vaxx <- as.data.frame(vaxx)
```

```{r clean vaccination data, include = FALSE}
# Clean vaccination data removing "_" from "_id".
names(vaxx)[names(vaxx) == "_id"] <- "id"

# Convert report data to date
vaxx$report_date <-
  ymd_hms(vaxx$report_date) # converts report date into date.

# Convert other columns to number
vaxx$id <- as.numeric(as.character(vaxx$id))
vaxx$previous_day_total_doses_administered <-
  as.numeric(as.character(vaxx$previous_day_total_doses_administered))
vaxx$previous_day_at_least_one <-
  as.numeric(as.character(vaxx$previous_day_at_least_one))
vaxx$previous_day_fully_vaccinated <-
  as.numeric(as.character(vaxx$previous_day_fully_vaccinated))
vaxx$total_doses_administered <-
  as.numeric(as.character(vaxx$total_doses_administered))
vaxx$total_individuals_at_least_one <-
  as.numeric(as.character(vaxx$total_individuals_at_least_one))
vaxx$total_doses_in_fully_vaccinated_individuals <-
  as.numeric(as.character(vaxx$total_doses_in_fully_vaccinated_individuals))
vaxx$total_individuals_fully_vaccinated <-
  as.numeric(as.character(vaxx$total_individuals_fully_vaccinated))
```

```{r missing christmas data, include = FALSE}
# The province administered the first vaccine on 2020-12-14 but didn't record data until 2020-12-24.
firstdoses <- head(vaxx$total_doses_administered, n = 1)
firstdose2020data <- data.frame(
  "id" = 0,
  "report_date" = c(
    "2020-12-15T00:00:00",
    "2020-12-16T00:00:00",
    "2020-12-17T00:00:00",
    "2020-12-18T00:00:00",
    "2020-12-19T00:00:00",
    "2020-12-20T00:00:00",
    "2020-12-21T00:00:00",
    "2020-12-22T00:00:00",
    "2020=12-23T00:00:00"
  ),
  "previous_day_total_doses_administered" = 0,
  "previous_day_at_least_one" = 0,
  "previous_day_fully_vaccinated" = 0,
  "total_doses_administered" = 0,
  "total_individuals_at_least_one" = 0,
  "total_doses_in_fully_vaccinated_individuals" = 0,
  "total_individuals_fully_vaccinated" = 0
)

# The province did not administer any vaccines between 2020-12-25 and 2020-12-29 but omits this data from the data set. Add missing Christmas 2020 values.
christmas2020data <- data.frame(
  "id" = 0,
  "report_date" = c(
    "2020-12-25T00:00:00",
    "2020-12-26T00:00:00",
    "2020-12-27T00:00:00",
    "2020-12-28T00:00:00",
    "2020-12-29T00:00:00"
  ),
  "previous_day_total_doses_administered" = c(firstdoses, 0, 0, 0, 0),
  "previous_day_at_least_one" = firstdoses,
  "previous_day_fully_vaccinated" = 0,
  "total_doses_administered" = firstdoses,
  "total_individuals_at_least_one" = firstdoses,
  "total_doses_in_fully_vaccinated_individuals" = 0,
  "total_individuals_fully_vaccinated" = 0
)

# converts report date into date.
firstdose2020data$report_date <- ymd_hms(firstdose2020data$report)
christmas2020data$report_date <-
  ymd_hms(christmas2020data$report_date)
```

```{r merge first doses and christmas 2020 data into data set, include = FALSE}
vaxx <-
  rbind(vaxx, firstdose2020data, christmas2020data) # merge with vaxx data
vaxx <- vaxx[order(vaxx$report_date),] # sort by report date
```

```{r create vaccination percentages, include = FALSE}
# Calculate new columns for vaccination of percentages of adults either partly vaccinated or fully vaccinated using adult population estimate.

# Total number of partially vaccinated adults
vaxx$part <-
  ((
    vaxx$total_doses_administered - vaxx$total_doses_in_fully_vaccinated_individuals
  )
  )

# Total number of adults either fully or partially vaccinated
vaxx$fullorpart <-
  ((vaxx$total_individuals_fully_vaccinated + vaxx$part))

# Number of adults who are neither fully or partially vaccinated
vaxx$none <- ((ONpop12plus - vaxx$fullorpart))

# Percentage shares
vaxx$percentagepart <-
  ((vaxx$part / ONpop12plus) * 100) # Part vaccinated
vaxx$percentagefully <-
  ((vaxx$total_individuals_fully_vaccinated / ONpop12plus) * 100) # Fully vaccinated
vaxx$percentagefullorpart <-
  ((vaxx$fullorpart / ONpop12plus) * 100) # Fully or partly vaccinated
vaxx$percentagenone <-
  ((vaxx$none / ONpop12plus) * 100) # No vaccination

# Round percentages to two decimals
vaxx$percentagefully <- round(vaxx$percentagefully, digits = 1)
vaxx$percentagepart <- round(vaxx$percentagepart, digits = 1)
vaxx$percentagefullorpart <-
  round(vaxx$percentagefullorpart, digits = 1)
vaxx$percentagenone <- round(vaxx$percentagenone, digits = 1)
```

```{r unlist vaccination data, include = FALSE}
# Subset percentage data for visualisation.
vizfullorpart <-
  subset(vaxx, select = c("report_date", "percentagefullorpart"))
vizfull <-
  subset(vaxx, select = c("report_date", "percentagefully"))
vizpart <- subset(vaxx, select = c("report_date", "percentagepart"))

# standardise column names
names(vizfullorpart)[names(vizfullorpart) == "percentagefullorpart"] <-
  "percentage"
names(vizfull)[names(vizfull) == "percentagefully"] <- "percentage"
names(vizpart)[names(vizpart) == "percentagepart"] <- "percentage"
```


### Vaccinated
Vaccination status as a percentage of the population
```{r create subset of vaccination status as percentage of adult population, include = FALSE}
bar <- tail(vaxx, n = 1)
bar <-
  subset(bar, select = c(percentagefully, percentagepart, percentagenone))
bar <- t(bar)
bar <- as_tibble(bar)
row.names(bar) <-
  c("Fully vaccinated", "Partly vaccinated", "No vaccination")
bar <- tibble::rownames_to_column(bar, "Status")
colnames(bar) <- c("Status", "Percentage")
# Round percentages to two decimals
bar$Percentage <- round(bar$Percentage, digits = 1)
```

```{r latest number of fully vaccinated, results = 'asis', echo = FALSE}
latest <-
  subset(vaxx,
         select = c(
           report_date,
           total_individuals_fully_vaccinated,
           part,
           fullorpart
         ))
colnames(latest) <-
  c("Report date", "Fully", "Partly", "Fully or partly ")
latest <- tail(latest, n = 1)
knitr::kable(latest, row.names = FALSE, align = "c")
```

```{r barplot visualisation of vaccination status as percentage of adult population, echo = FALSE}
bar$Status <-
  factor(bar$Status,
         levels = c("No vaccination", "Partly vaccinated", "Fully vaccinated"))
ggplot(bar, aes(x = "", y = Percentage, fill = Status)) +
  geom_bar(stat = "identity", width = .375) +
  geom_text(aes(label = paste0(Percentage, sep = "%")),
            position = position_stack(vjust = .5),
            size = 2.5) +
  labs(
    x = NULL,
    y = NULL,
    caption = "Data: Ontario COVID-19 vaccine data, Ontario COVID-19 vaccine data by age",
    title = "Ontario COVID-19 vaccination status of population (aged 12+)",
    subtitle = Sys.Date()
  ) +
  theme_classic() +
  theme(
    axis.line = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank()
  ) +
  scale_fill_brewer(palette = "Greys") +
  coord_flip()
```

### Vaccination status by Public Health Region
```{r filter public health unit data to age 12+, echo = FALSE}
PHU12plus <-
  PHU %>% filter(Agegroup == "Ontario_12plus") # filter out all the other age ranges so just total for 12+ remains
```

```{r get most recent reporting date PHU data, echo = FALSE}
recentPHU <-
  tail(PHU12plus, n = 35) # Get the most recent day of data for the 34 units, plus "unknown"
recentPHU <-
  recentPHU %>% select(
    Date,
    PHU.name,
    At.least.one.dose_cumulative,
    Second_dose_cumulative,
    Total.population
  ) %>% mutate(At.least.one.dose_cumulative = At.least.one.dose_cumulative - Second_dose_cumulative) %>% mutate(None = Total.population - (At.least.one.dose_cumulative + Second_dose_cumulative)) %>% rename(
    Unit = PHU.name,
    Partly = At.least.one.dose_cumulative,
    Fully = Second_dose_cumulative,
    Population = Total.population
  )  %>% relocate(Date, Unit, None, Partly, Fully, Population)
recentPHU_pct <-
  recentPHU %>% mutate(
    None_pct = None / Population * 100,
    Partly_pct = Partly / Population * 100,
    Fully_pct = Fully / Population * 100
  ) # Create percentage values for vaccination status in each PHU
recentPHU_pct$Unit <-
  str_to_title(recentPHU_pct$Unit, locale = "en") # Convert from uppercase text to sentence
```

```{r subset full vaccinated percentage status for each PHU, echo = FALSE}
full_recentPHU_pct <-
  recentPHU_pct %>% select(Unit, Fully_pct) %>% mutate(Status = "Fully") %>% rename(Percent = Fully_pct)
```

```{r subset partly vaccinated percentage status for each PHU, echo = FALSE}
partly_recentPHU_pct <-
  recentPHU_pct %>% select(Unit, Partly_pct) %>% mutate(Status = "Partly") %>% rename(Percent = Partly_pct)
```

```{r subset non vaccinated percentage for each PHU, echo = FALSE}
none_recentPHU_pct <-
  recentPHU_pct %>% select(Unit, None_pct) %>% mutate(Status = "None") %>% rename(Percent = None_pct)
```

```{r combine into a data frame for visualisation, echo = FALSE}
PHU_viz <-
  rbind(full_recentPHU_pct, partly_recentPHU_pct, none_recentPHU_pct)
PHU_viz <-
  PHU_viz %>% filter(Unit != "Unknown") # Remove the "Unknown" category group
PHU_viz$Status <-
  factor(PHU_viz$Status, levels = c("None", "Partly", "Fully")) # Reorder by vaccnination status.
```

```{r stacked bar chart visualisation for Public Health Unit, echo = FALSE}
ggplot(data = PHU_viz, aes(
  x = factor(Unit, levels = rev(levels(factor(
    Unit
  )))),
  y = Percent,
  fill = Status
)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(limits = c(0, 101)) +
  labs(
    y = "%",
    x = "",
    caption = "Data: Ontario COVID-19 Vaccine data by Public Health Unit",
    title = "Vaccination status of population (age 12+)",
    subtitle = Sys.Date()
  ) +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_line(colour = "grey", size = 0.25),
    panel.grid.minor.x = element_blank(),
    panel.background = element_rect(fill = "#FFFFFF", color = "white"),
  ) +
  scale_fill_brewer(palette = "Greys") +
  coord_flip()
```


### Progress
```{r vaccine percentage population visualisation, echo = FALSE}
ggplot(vizfull, aes(report_date, percentage)) +
  geom_line(aes(linetype = "Fully")) +
  geom_line(data = vizpart, aes(linetype = "Partly")) +
  scale_y_continuous(limits = c(0, 100)) +
  labs(
    linetype = "Vaccinated",
    x = "",
    y = "%",
    caption = "Data: Ontario COVID-19 vaccine data, Ontario COVID-19 vaccine data by age",
    title = "Ontario COVID-19 vaccination, 2020-2021",
    subtitle = "Percentage of population (aged 12+)"
  ) +
  theme(legend.position = "right", panel.grid.minor = element_blank())
```


### Vaccine doses
```{r latest number of vaccine doses, results = 'asis', echo = FALSE}
latestdoses <-
  subset(
    vaxx,
    select = c(
      report_date,
      previous_day_total_doses_administered,
      total_doses_administered
    )
  )
colnames(latestdoses) <-
  c("Report date",
    "Previous day doses administered",
    "Total number of doses administered")
latestdoses <- tail(latestdoses, n = 1)
knitr::kable(latestdoses, row.names = FALSE, align = "c")
```
  
  
### Daily and cumulative vaccine doses  
```{r daily and cumilative totals of vaccine administered, echo = FALSE}
# Subset data
dosesadministered <-
  subset(
    vaxx,
    select = c(
      "report_date",
      "previous_day_total_doses_administered",
      "total_doses_administered"
    )
  )

# Create new column for data administered using reported date minus 24 hours in seconds.
dosesadministered$administered_date <-
  ((dosesadministered$report_date - 86400))
dosesadministered <-
  subset (dosesadministered, select = -report_date) # drop reported date column
names(dosesadministered) <-
  c("doses", "totaldoses", "administered") # rename columns
dosesadministered$administered <-
  as.Date(dosesadministered$administered) # ensure date is a date field and not character.

# Visualisation
ggplot() +
  labs(title = "Ontario COVID-19 vaccination",
       subtitle = "Daily doses of vaccine and cumilative doses administered, 2020-2021",
       caption = "Source: Ontario COVID-19 vaccine data") +
  geom_bar(
    mapping = aes(x = dosesadministered$administered, y = dosesadministered$doses),
    stat = "identity"
  ) +
  geom_line(
    mapping = aes(x = dosesadministered$administered, y = dosesadministered$totaldoses *
                    .01),
    size = 1,
    color = "blue",
  ) +
  scale_x_date(name = "") +
  scale_y_continuous(name = "Daily doses",
                     sec.axis = sec_axis(~ . / 10000, name = "Cumilative (million)")) +
  theme(
    axis.title.y = element_text(color = "black"),
    axis.title.y.right = element_text(color = "blue"),
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )
```

### Age group
```{r latest age group data, echo = FALSE}
agerecent <-
  select(
    latestage,
    Agegroup,
    At.least.one.dose_cumulative,
    Second_dose_cumulative,
    Total.population
  )

agerecent <-
  subset(
    agerecent,
    Agegroup != "Adults_18plus" &
      Agegroup != "Undisclosed_or_missing" &
      Agegroup != "Ontario_12plus"
  ) # Remove the adult total, 12+ total, and NA groups.

# Subtract Second dose total from at least one total
agerecent <-
  mutate(agerecent,
         At.least.one.dose = At.least.one.dose_cumulative - Second_dose_cumulative)

# Convert to percentages. Multiply one dose percentage by -1 to give a negative number for visualisation.
agerecent <-
  agerecent %>% mutate(one.dose_pct = At.least.one.dose / Total.population * 100) %>% mutate(two.dose_pct = Second_dose_cumulative / Total.population * 100) %>% mutate(one.dose_pct = one.dose_pct * -1)

# Add categorical variable for partly and fully vaccinated individuals.
age1 <- agerecent %>% select(Agegroup, one.dose_pct)
age2 <- agerecent %>% select(Agegroup, two.dose_pct)
age1 <- rename(age1, Total = one.dose_pct)
age2 <- rename(age2, Total = two.dose_pct)
age1$Status <- "Partly"
age2$Status <- "Fully"
age <- rbind(age1, age2)
```

```{r visualisation for vaccination by age group, echo = FALSE}
age$Status <- factor(age$Status, levels = c("Partly", "Fully"))
ggplot(data = age, aes(x = Agegroup, y = Total, fill = Status)) +
  geom_bar(stat = "identity") +
  labs(
    y = "% of age group",
    x = "",
    caption = "Data: Ontario COVID-19 vaccine data by age",
    title = "Ontario COVID-19 vaccination status of population (aged 12+)",
    subtitle = Sys.Date()
  ) +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_line(colour = "grey", size = 0.25),
    panel.grid.minor.x = element_blank(),
    panel.background = element_rect(fill = "#FFFFFF", color = "white"),
  ) +
  scale_fill_brewer(palette = "Greys") +
  coord_flip()
```


## Citations
### Data
Ontario COVID-19 Vaccine Data https://data.ontario.ca/dataset/covid-19-vaccine-data-in-ontario/resource/8a89caa9-511c-4568-af89-7f2174b4378c?view_id=9e42f55b-723f-46dd-b0d9-643670e01fed published under Open Government Licence – Ontario version 1.0 (https://www.ontario.ca/page/open-government-licence-ontario)

Ontario COVID-19 Vaccine Data by Age https://data.ontario.ca/dataset/covid-19-vaccine-data-in-ontario/resource/775ca815-5028-4e9b-9dd4-6975ff1be021 published under Open Government Licence – Ontario version 1.0 (https://www.ontario.ca/page/open-government-licence-ontario)

Ontario COVID-19 Vaccine Data by Public Health Unit
https://data.ontario.ca/dataset/covid-19-vaccine-data-in-ontario/resource/2a362139-b782-43b1-b3cb-078a2ef19524 published under Open Government Licence – Ontario version 1.0 (https://www.ontario.ca/page/open-government-licence-ontario)

### Code
Horton, L. (2021). Ontario COVID-19 Vaccinations. *GitHub repository*, https://github.com/laurencehorton/ontario-covid-vaccinations published under Creative Commons Zero v1.0 Universal https://github.com/laurencehorton/ontario-covid-vaccinations/blob/main/LICENSE 

```{r citations, include = FALSE}
toBibtex(citation("base"))
toBibtex(citation("knitr"))
toBibtex(citation("lubridate"))
toBibtex(citation("rjson"))
toBibtex(citation("tidyverse"))
toBibtex(citation("rmarkdown"))
toBibtex(citation("readxl"))
toBibtex(citation("stringr"))